// Generated by CoffeeScript 1.4.0
(function() {
  var Event, EventBus, Subscriber, createAndPublishEvent, isFunction, pushEventToSubscribers, root, subscribeToEventType;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  EventBus = (function() {

    function EventBus() {
      this.subscribers = [];
    }

    EventBus.prototype.createEvent = function(eventType, data, callback) {
      return new Event(this, eventType, data, callback);
    };

    EventBus.prototype.publish = function(eventType, data, callback) {
      var eventTypes;
      eventTypes = [].concat(eventType);
      if (isFunction(data)) {
        callback = data;
        data = {};
      }
      return createAndPublishEvent(this, eventTypes, data, callback);
    };

    EventBus.prototype.reset = function() {
      return this.subscribers = [];
    };

    EventBus.prototype.subscribe = function(eventType, callback) {
      var eventTypes;
      eventTypes = [].concat(eventType);
      return subscribeToEventType(this, eventTypes, callback);
    };

    EventBus.prototype.unsubscribe = function(eventType) {
      var eventTypes, subscriber, tmpSubscribers, _i, _j, _len, _len1, _ref, _results;
      eventTypes = [].concat(eventType);
      _results = [];
      for (_i = 0, _len = eventTypes.length; _i < _len; _i++) {
        eventType = eventTypes[_i];
        tmpSubscribers = [];
        _ref = this.subscribers;
        for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
          subscriber = _ref[_j];
          if (subscriber.eventType !== eventType) {
            tmpSubscribers.push(subscriber);
          } else {
            this.publish("EventBus.unsubscribed", {
              subscriber: subscriber
            });
          }
        }
        _results.push(this.subscribers = tmpSubscribers);
      }
      return _results;
    };

    return EventBus;

  })();

  Event = (function() {

    function Event(eventBus, eventType, data, callback) {
      this.eventBus = eventBus;
      this.eventType = eventType;
      this.data = data != null ? data : {};
      this.callback = callback;
      this.timestamp = Date.now().toString();
    }

    Event.prototype.push = function(subscriber) {
      var response, _ref;
      response = (_ref = subscriber.callback(this)) != null ? _ref : {};
      if (isFunction(this.callback)) {
        return this.callback(response);
      }
    };

    return Event;

  })();

  Subscriber = (function() {

    function Subscriber(eventType, callback) {
      this.eventType = eventType;
      this.callback = callback;
    }

    return Subscriber;

  })();

  createAndPublishEvent = function(eventBus, eventTypes, eventData, callback) {
    var event, eventType, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = eventTypes.length; _i < _len; _i++) {
      eventType = eventTypes[_i];
      event = eventBus.createEvent(eventType, eventData, callback);
      _results.push(pushEventToSubscribers(eventBus, event));
    }
    return _results;
  };

  isFunction = function(obj) {
    return !!(obj && obj.constructor && obj.call && obj.apply);
  };

  pushEventToSubscribers = function(eventBus, event) {
    var subscriber, _i, _len, _ref, _results;
    _ref = eventBus.subscribers;
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      subscriber = _ref[_i];
      if (subscriber.eventType === event.eventType) {
        _results.push(event.push(subscriber));
      }
    }
    return _results;
  };

  subscribeToEventType = function(eventBus, eventTypes, callback) {
    var eventType, subscriber, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = eventTypes.length; _i < _len; _i++) {
      eventType = eventTypes[_i];
      subscriber = new Subscriber(eventType, callback);
      eventBus.subscribers.push(subscriber);
      _results.push(eventBus.publish("EventBus.subscribed", {
        subscriber: subscriber
      }));
    }
    return _results;
  };

  if (!root.eventBus) {
    root.eventBus = new EventBus();
  }

}).call(this);
